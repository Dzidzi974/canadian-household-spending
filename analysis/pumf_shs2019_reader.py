import pandas as pd
import argparse
import os

def parse_fixed_width_file(input_file, output_file=None):
    """
    Parse a fixed-width file based on the PUMF SHS 2019 layout.
    
    Args:
        input_file (str): Path to the fixed-width data file
        output_file (str, optional): Path for the output CSV file. 
                                     If not provided, will use input file name with .csv extension.
    """
    
    # Column specifications based on the layout
    col_specs = [
        (0, 6),     # CASEID
        (6, 24),    # WEIGHTD
        (24, 26),   # PROV
        (26, 27),   # HHTYPE6
        (27, 28),   # HHSIZE
        (28, 29),   # P0TO4YN
        (29, 30),   # P5TO15YN
        (30, 31),   # P16TO29YN
        (31, 32),   # P30TO64YN
        (32, 33),   # P65TO74YN
        (33, 34),   # P75PLUSYN
        (34, 36),   # RP_AGEGRP
        (36, 37),   # RP_GENDER
        (37, 38),   # RP_MARSTAT
        (38, 39),   # RP_EDUC
        (39, 40),   # SPOUSEYN
        (40, 42),   # SP_AGEGRP
        (42, 43),   # SP_GENDER
        (43, 44),   # SP_EDUC
        (44, 45),   # DWELTYP
        (45, 46),   # TENURE
        (46, 47),   # NUMBEDR
        (47, 48),   # SECRESYN
        (48, 49),   # OTHPROPYN
        (49, 50),   # LANDLINEYN
        (50, 51),   # NUMCELL
        (51, 52),   # COMPUTERYN
        (52, 53),   # INTERNETYN
        (53, 54),   # INTCON_HSTEL
        (54, 55),   # INTCON_CABLE
        (55, 56),   # INTCON_WIRELESS
        (56, 57),   # INTCON_OTHER
        (57, 58),   # TVCON_CABLE
        (58, 59),   # TVCON_SATDISH
        (59, 60),   # TVCON_PHONE
        (60, 61),   # VEHICLEYN
        (61, 62),   # RECVEHYN
        (62, 73),   # RP_TOTINC
        (73, 84),   # SP_TOTINC
        (84, 95),   # OTH_TOTINC
        (95, 106),  # HH_TOTINC
        (106, 107), # HH_MAJINCSRC
        (107, 118), # CC001
        (118, 129), # CL014
        (129, 140), # CL015
        (140, 151), # CL016
        (151, 162), # CL017
        (162, 173), # CL023
        (173, 184), # CL026
        (184, 195), # CL029
        (195, 206), # CL030
        (206, 217), # CL990
        (217, 228), # CS003
        (228, 239), # CS004
        (239, 250), # CS005
        (250, 261), # CS007
        (261, 272), # CS008
        (272, 283), # CS020
        (283, 294), # CS021
        (294, 305), # CS030
        (305, 316), # ED002
        (316, 327), # ED003
        (327, 338), # ED030
        (338, 349), # EP011
        (349, 360), # FD001
        (360, 371), # FD003
        (371, 382), # FD100
        (382, 393), # FD1001
        (393, 404), # FD1002
        (404, 415), # FD1003
        (415, 426), # FD1004
        (426, 437), # FD101
        (437, 448), # FD102
        (448, 459), # FD103
        (459, 470), # FD104
        (470, 481), # FD105
        (481, 492), # FD106
        (492, 503), # FD107
        (503, 514), # FD108
        (514, 525), # FD112
        (525, 536), # FD200
        (536, 547), # FD201
        (547, 558), # FD202
        (558, 569), # FD203
        (569, 580), # FD204
        (580, 591), # FD205
        (591, 602), # FD206
        (602, 613), # FD207
        (613, 624), # FD208
        (624, 635), # FD209
        (635, 646), # FD212
        (646, 657), # FD300
        (657, 668), # FD301
        (668, 679), # FD302
        (679, 690), # FD303
        (690, 701), # FD304
        (701, 712), # FD305
        (712, 723), # FD308
        (723, 724), # FD309 - Note: Adjusted to single character based on position
        (724, 735), # FD315
        (735, 746), # FD316
        (746, 757), # FD330
        (757, 768), # FD331
        (768, 779), # FD350
        (779, 790), # FD380
        (790, 801), # FD381
        (801, 812), # FD382
        (812, 823), # FD400
        (823, 834), # FD401
        (834, 845), # FD402
        (845, 856), # FD403
        (856, 867), # FD404
        (867, 878), # FD405
        (878, 889), # FD406
        (889, 900), # FD407
        (900, 911), # FD408
        (911, 922), # FD409
        (922, 933), # FD410
        (933, 944), # FD411
        (944, 955), # FD412
        (955, 966), # FD418
        (966, 977), # FD421
        (977, 988), # FD440
        (988, 999), # FD441
        (999, 1010), # FD442
        (1010, 1021), # FD447
        (1021, 1032), # FD470
        (1032, 1043), # FD471
        (1043, 1054), # FD478
        (1054, 1065), # FD479
        (1065, 1076), # FD500
        (1076, 1087), # FD501
        (1087, 1098), # FD502
        (1098, 1109), # FD503
        (1109, 1120), # FD504
        (1120, 1131), # FD505
        (1131, 1142), # FD520
        (1142, 1153), # FD521
        (1153, 1164), # FD522
        (1164, 1175), # FD525
        (1175, 1186), # FD540
        (1186, 1197), # FD541
        (1197, 1208), # FD550
        (1208, 1219), # FD551
        (1219, 1230), # FD555
        (1230, 1241), # FD570
        (1241, 1252), # FD571
        (1252, 1263), # FD572
        (1263, 1274), # FD600
        (1274, 1285), # FD601
        (1285, 1296), # FD602
        (1296, 1307), # FD603
        (1307, 1318), # FD604
        (1318, 1329), # FD607
        (1329, 1340), # FD650
        (1340, 1351), # FD651
        (1351, 1362), # FD660
        (1362, 1373), # FD700
        (1373, 1384), # FD701
        (1384, 1395), # FD705
        (1395, 1406), # FD706
        (1406, 1417), # FD720
        (1417, 1428), # FD721
        (1428, 1439), # FD722
        (1439, 1450), # FD723
        (1450, 1461), # FD724
        (1461, 1472), # FD730
        (1472, 1483), # FD731
        (1483, 1494), # FD732
        (1494, 1505), # FD800
        (1505, 1516), # FD801
        (1516, 1527), # FD802
        (1527, 1538), # FD806
        (1538, 1549), # FD814
        (1549, 1560), # FD815
        (1560, 1571), # FD821
        (1571, 1582), # FD827
        (1582, 1593), # FD828
        (1593, 1604), # FD829
        (1604, 1615), # FD833
        (1615, 1626), # FD834
        (1626, 1637), # FD835
        (1637, 1648), # FD836
        (1648, 1659), # FD837
        (1659, 1670), # FD838
        (1670, 1681), # FD839
        (1681, 1692), # FD840
        (1692, 1703), # FD841
        (1703, 1714), # FD842
        (1714, 1725), # FD843
        (1725, 1736), # FD844
        (1736, 1747), # FD845
        (1747, 1758), # FD846
        (1758, 1769), # FD847
        (1769, 1780), # FD850
        (1780, 1791), # FD851
        (1791, 1802), # FD852
        (1802, 1813), # FD853
        (1813, 1824), # FD854
        (1824, 1835), # FD855
        (1835, 1846), # FD857
        (1846, 1857), # FD870
        (1857, 1868), # FD871
        (1868, 1879), # FD872
        (1879, 1890), # FD873
        (1890, 1901), # FD874
        (1901, 1912), # FD875
        (1912, 1923), # FD879
        (1923, 1934), # FD880
        (1934, 1945), # FD881
        (1945, 1956), # FD882
        (1956, 1967), # FD883
        (1967, 1978), # FD884
        (1978, 1989), # FD885
        (1989, 2000), # FD889
        (2000, 2011), # FD990
        (2011, 2022), # FD991
        (2022, 2033), # FD992
        (2033, 2044), # FD993
        (2044, 2055), # FD994
        (2055, 2066), # FD995
        (2066, 2077), # GC001
        (2077, 2088), # HC001
        (2088, 2099), # HC001_C
        (2099, 2110), # HC001_D
        (2110, 2121), # HC002
        (2121, 2132), # HC002_C
        (2132, 2143), # HC002_D
        (2143, 2154), # HC022
        (2154, 2165), # HC025
        (2165, 2176), # HC061
        (2176, 2187), # HE001
        (2187, 2198), # HE001_C
        (2198, 2209), # HE001_D
        (2209, 2220), # HE002
        (2220, 2231), # HE002_C
        (2231, 2242), # HE002_D
        (2242, 2253), # HE010
        (2253, 2264), # HE010_C
        (2264, 2275), # HE010_D
        (2275, 2286), # HE017
        (2286, 2297), # HE020
        (2297, 2308), # HF001
        (2308, 2319), # HF001_C
        (2319, 2330), # HF001_D
        (2330, 2341), # HF002
        (2341, 2352), # HF002_C
        (2352, 2363), # HF002_D
        (2363, 2374), # HO001
        (2374, 2385), # HO001_C
        (2385, 2396), # HO001_D
        (2396, 2407), # HO002
        (2407, 2418), # HO003
        (2418, 2429), # HO003_C
        (2429, 2440), # HO003_D
        (2440, 2451), # HO004
        (2451, 2462), # HO005
        (2462, 2473), # HO006
        (2473, 2484), # HO010
        (2484, 2495), # HO014
        (2495, 2506), # HO018
        (2506, 2517), # HO018_C
        (2517, 2528), # HO018_D
        (2528, 2539), # HO022
        (2539, 2550), # ME001
        (2550, 2561), # ME001_C
        (2561, 2572), # ME001_D
        (2572, 2583), # ME039
        (2583, 2594), # ME040
        (2594, 2605), # ME040_C
        (2605, 2616), # ME040_D
        (2616, 2627), # MG001
        (2627, 2638), # PC001
        (2638, 2649), # PC001_C
        (2649, 2660), # PC001_D
        (2660, 2671), # PC002
        (2671, 2682), # PC020
        (2682, 2693), # RE001
        (2693, 2704), # RE001_C
        (2704, 2715), # RE001_D
        (2715, 2726), # RE002
        (2726, 2737), # RE002_C
        (2737, 2748), # RE002_D
        (2748, 2759), # RE003
        (2759, 2770), # RE006
        (2770, 2781), # RE007
        (2781, 2792), # RE010
        (2792, 2803), # RE010_C
        (2803, 2814), # RE010_D
        (2814, 2825), # RE016
        (2825, 2836), # RE020
        (2836, 2847), # RE022
        (2847, 2858), # RE032
        (2858, 2869), # RE040
        (2869, 2880), # RE040_C
        (2880, 2891), # RE040_D
        (2891, 2902), # RE041
        (2902, 2913), # RE041_C
        (2913, 2924), # RE041_D
        (2924, 2935), # RE052
        (2935, 2946), # RE060
        (2946, 2957), # RE060_C
        (2957, 2968), # RE060_D
        (2968, 2979), # RE061
        (2979, 2990), # RE061_C
        (2990, 3001), # RE061_D
        (3001, 3012), # RE062
        (3012, 3023), # RE063
        (3023, 3034), # RE066
        (3034, 3045), # RE067
        (3045, 3056), # RE074
        (3056, 3067), # RE090
        (3067, 3078), # RE120
        (3078, 3089), # RE124
        (3089, 3100), # RE124_C
        (3100, 3111), # RE124_D
        (3111, 3122), # RE127
        (3122, 3133), # RE140
        (3133, 3144), # RE990
        (3144, 3155), # RO001
        (3155, 3166), # RO001_C
        (3166, 3177), # RO001_D
        (3177, 3188), # RO002
        (3188, 3199), # RO003
        (3199, 3210), # RO004
        (3210, 3221), # RO005
        (3221, 3232), # RO010
        (3232, 3243), # RV001
        (3243, 3254), # RV010
        (3254, 3265), # RV020
        (3265, 3276), # SH001
        (3276, 3287), # SH002
        (3287, 3298), # SH003
        (3298, 3309), # SH004
        (3309, 3320), # SH010
        (3320, 3331), # SH011
        (3331, 3342), # SH015
        (3342, 3353), # SH016
        (3353, 3364), # SH019
        (3364, 3375), # SH030
        (3375, 3386), # SH031
        (3386, 3397), # SH032
        (3397, 3408), # SH033
        (3408, 3419), # SH034
        (3419, 3430), # SH040
        (3430, 3441), # SH041
        (3441, 3452), # SH042
        (3452, 3463), # SH044
        (3463, 3474), # SH046
        (3474, 3485), # SH047
        (3485, 3496), # SH050
        (3496, 3507), # SH060
        (3507, 3518), # SH061
        (3518, 3529), # SH062
        (3529, 3540), # SH082
        (3540, 3551), # SH990
        (3551, 3562), # SH991
        (3562, 3573), # SH992
        (3573, 3584), # TA005
        (3584, 3595), # TA006
        (3595, 3606), # TA007
        (3606, 3617), # TA008
        (3617, 3628), # TA018
        (3628, 3639), # TA018_C
        (3639, 3650), # TA018_D
        (3650, 3661), # TA990
        (3661, 3672), # TC001
        (3672, 3683), # TC001_C
        (3683, 3694), # TC001_D
        (3694, 3705), # TE001
        (3705, 3716), # TE001_C
        (3716, 3727), # TE001_D
        (3727, 3738), # TR001
        (3738, 3749), # TR001_C
        (3749, 3760), # TR001_D
        (3760, 3771), # TR002
        (3771, 3782), # TR002_C
        (3782, 3793), # TR002_D
        (3793, 3804), # TR003
        (3804, 3815), # TR004
        (3815, 3826), # TR008
        (3826, 3837), # TR010
        (3837, 3848), # TR020
        (3848, 3859), # TR020_C
        (3859, 3870), # TR020_D
        (3870, 3881), # TR021
        (3881, 3892), # TR022
        (3892, 3903), # TR030
        (3903, 3914), # TR030_C
        (3914, 3925), # TR030_D
        (3925, 3936), # TR031
        (3936, 3947), # TR033
        (3947, 3958), # TR034
        (3958, 3969), # TR036
        (3969, 3980), # TR038
        (3980, 3991), # TR039
        (3991, 4002), # TR070
        (4002, 4013), # TR071
        (4013, 4024), # TR085
        (4024, 4035), # TX010
    ]
    
    # Column names based on the layout
    col_names = [
        'CASEID', 'WEIGHTD', 'PROV', 'HHTYPE6', 'HHSIZE', 'P0TO4YN', 'P5TO15YN',
        'P16TO29YN', 'P30TO64YN', 'P65TO74YN', 'P75PLUSYN', 'RP_AGEGRP', 'RP_GENDER',
        'RP_MARSTAT', 'RP_EDUC', 'SPOUSEYN', 'SP_AGEGRP', 'SP_GENDER', 'SP_EDUC',
        'DWELTYP', 'TENURE', 'NUMBEDR', 'SECRESYN', 'OTHPROPYN', 'LANDLINEYN',
        'NUMCELL', 'COMPUTERYN', 'INTERNETYN', 'INTCON_HSTEL', 'INTCON_CABLE',
        'INTCON_WIRELESS', 'INTCON_OTHER', 'TVCON_CABLE', 'TVCON_SATDISH', 'TVCON_PHONE',
        'VEHICLEYN', 'RECVEHYN', 'RP_TOTINC', 'SP_TOTINC', 'OTH_TOTINC', 'HH_TOTINC',
        'HH_MAJINCSRC', 'CC001', 'CL014', 'CL015', 'CL016', 'CL017', 'CL023', 'CL026',
        'CL029', 'CL030', 'CL990', 'CS003', 'CS004', 'CS005', 'CS007', 'CS008', 'CS020',
        'CS021', 'CS030', 'ED002', 'ED003', 'ED030', 'EP011', 'FD001', 'FD003', 'FD100',
        'FD1001', 'FD1002', 'FD1003', 'FD1004', 'FD101', 'FD102', 'FD103', 'FD104',
        'FD105', 'FD106', 'FD107', 'FD108', 'FD112', 'FD200', 'FD201', 'FD202', 'FD203',
        'FD204', 'FD205', 'FD206', 'FD207', 'FD208', 'FD209', 'FD212', 'FD300', 'FD301',
        'FD302', 'FD303', 'FD304', 'FD305', 'FD308', 'FD309', 'FD315', 'FD316', 'FD330',
        'FD331', 'FD350', 'FD380', 'FD381', 'FD382', 'FD400', 'FD401', 'FD402', 'FD403',
        'FD404', 'FD405', 'FD406', 'FD407', 'FD408', 'FD409', 'FD410', 'FD411', 'FD412',
        'FD418', 'FD421', 'FD440', 'FD441', 'FD442', 'FD447', 'FD470', 'FD471', 'FD478',
        'FD479', 'FD500', 'FD501', 'FD502', 'FD503', 'FD504', 'FD505', 'FD520', 'FD521',
        'FD522', 'FD525', 'FD540', 'FD541', 'FD550', 'FD551', 'FD555', 'FD570', 'FD571',
        'FD572', 'FD600', 'FD601', 'FD602', 'FD603', 'FD604', 'FD607', 'FD650', 'FD651',
        'FD660', 'FD700', 'FD701', 'FD705', 'FD706', 'FD720', 'FD721', 'FD722', 'FD723',
        'FD724', 'FD730', 'FD731', 'FD732', 'FD800', 'FD801', 'FD802', 'FD806', 'FD814',
        'FD815', 'FD821', 'FD827', 'FD828', 'FD829', 'FD833', 'FD834', 'FD835', 'FD836',
        'FD837', 'FD838', 'FD839', 'FD840', 'FD841', 'FD842', 'FD843', 'FD844', 'FD845',
        'FD846', 'FD847', 'FD850', 'FD851', 'FD852', 'FD853', 'FD854', 'FD855', 'FD857',
        'FD870', 'FD871', 'FD872', 'FD873', 'FD874', 'FD875', 'FD879', 'FD880', 'FD881',
        'FD882', 'FD883', 'FD884', 'FD885', 'FD889', 'FD990', 'FD991', 'FD992', 'FD993',
        'FD994', 'FD995', 'GC001', 'HC001', 'HC001_C', 'HC001_D', 'HC002', 'HC002_C',
        'HC002_D', 'HC022', 'HC025', 'HC061', 'HE001', 'HE001_C', 'HE001_D', 'HE002',
        'HE002_C', 'HE002_D', 'HE010', 'HE010_C', 'HE010_D', 'HE017', 'HE020', 'HF001',
        'HF001_C', 'HF001_D', 'HF002', 'HF002_C', 'HF002_D', 'HO001', 'HO001_C', 'HO001_D',
        'HO002', 'HO003', 'HO003_C', 'HO003_D', 'HO004', 'HO005', 'HO006', 'HO010', 'HO014',
        'HO018', 'HO018_C', 'HO018_D', 'HO022', 'ME001', 'ME001_C', 'ME001_D', 'ME039',
        'ME040', 'ME040_C', 'ME040_D', 'MG001', 'PC001', 'PC001_C', 'PC001_D', 'PC002',
        'PC020', 'RE001', 'RE001_C', 'RE001_D', 'RE002', 'RE002_C', 'RE002_D', 'RE003',
        'RE006', 'RE007', 'RE010', 'RE010_C', 'RE010_D', 'RE016', 'RE020', 'RE022', 'RE032',
        'RE040', 'RE040_C', 'RE040_D', 'RE041', 'RE041_C', 'RE041_D', 'RE052', 'RE060',
        'RE060_C', 'RE060_D', 'RE061', 'RE061_C', 'RE061_D', 'RE062', 'RE063', 'RE066',
        'RE067', 'RE074', 'RE090', 'RE120', 'RE124', 'RE124_C', 'RE124_D', 'RE127', 'RE140',
        'RE990', 'RO001', 'RO001_C', 'RO001_D', 'RO002', 'RO003', 'RO004', 'RO005', 'RO010',
        'RV001', 'RV010', 'RV020', 'SH001', 'SH002', 'SH003', 'SH004', 'SH010', 'SH011',
        'SH015', 'SH016', 'SH019', 'SH030', 'SH031', 'SH032', 'SH033', 'SH034', 'SH040',
        'SH041', 'SH042', 'SH044', 'SH046', 'SH047', 'SH050', 'SH060', 'SH061', 'SH062',
        'SH082', 'SH990', 'SH991', 'SH992', 'TA005', 'TA006', 'TA007', 'TA008', 'TA018',
        'TA018_C', 'TA018_D', 'TA990', 'TC001', 'TC001_C', 'TC001_D', 'TE001', 'TE001_C',
        'TE001_D', 'TR001', 'TR001_C', 'TR001_D', 'TR002', 'TR002_C', 'TR002_D', 'TR003',
        'TR004', 'TR008', 'TR010', 'TR020', 'TR020_C', 'TR020_D', 'TR021', 'TR022', 'TR030',
        'TR030_C', 'TR030_D', 'TR031', 'TR033', 'TR034', 'TR036', 'TR038', 'TR039', 'TR070',
        'TR071', 'TR085', 'TX010'
    ]
    
    # Determine output file name if not provided
    if output_file is None:
        output_file = os.path.splitext(input_file)[0] + '.csv'
    
    try:
        # Read the fixed-width file
        print(f"Reading {input_file}...")
        df = pd.read_fwf(input_file, colspecs=col_specs, names=col_names, header=None)
        
        # Save as CSV
        print(f"Saving to {output_file}...")
        df.to_csv(output_file, index=False)
        print(f"Successfully converted {input_file} to {output_file}")
        
        # Display basic information about the data
        print(f"\nData Overview:")
        print(f"Number of rows: {df.shape[0]}")
        print(f"Number of columns: {df.shape[1]}")
        print(f"\nFirst few rows:")
        print(df.head())
        
        return df
        
    except Exception as e:
        print(f"Error processing file: {e}")
        return None

def main():
    parser = argparse.ArgumentParser(description='Convert fixed-width data file to CSV based on PUMF SHS 2019 layout')
    parser.add_argument('input_file', help='Path to the fixed-width data file')
    parser.add_argument('-o', '--output', help='Output CSV file path (optional)')
    
    args = parser.parse_args()
    
    # Check if input file exists
    if not os.path.isfile(args.input_file):
        print(f"Error: Input file '{args.input_file}' does not exist.")
        return
    
    # Parse the file
    parse_fixed_width_file(args.input_file, args.output)

if __name__ == "__main__":
    main()